#!/usr/bin/env python3
"""Manage systemd user services for Linux Voice Assistant instances."""

import sys
import json
import subprocess
import time
from pathlib import Path

_SCRIPT_DIR = Path(__file__).parent
_REPO_DIR = _SCRIPT_DIR.parent
_PREFS_USER_DIR = _REPO_DIR / "preferences" / "user"
_SERVICE_DIR = Path.home() / ".config" / "systemd" / "user"

def _get_service_name(instance_name: str) -> str:
    """Get service name for instance."""
    return f"{instance_name}.service"

def _get_service_path(instance_name: str) -> Path:
    """Get path to service file."""
    return _SERVICE_DIR / _get_service_name(instance_name)

def _get_all_instances() -> list:
    """Get all instance names from preferences/user/*_cli.json."""
    instances = []
    if not _PREFS_USER_DIR.exists():
        return instances
    
    for cli_file in _PREFS_USER_DIR.glob("*_cli.json"):
        name = cli_file.stem.replace("_cli", "")
        instances.append(name)
    
    return instances

def _get_autostart_instances() -> list:
    """Get instances with autostart: true."""
    autostart = []
    if not _PREFS_USER_DIR.exists():
        return autostart
    
    for cli_file in _PREFS_USER_DIR.glob("*_cli.json"):
        try:
            with open(cli_file, "r", encoding="utf-8") as f:
                config = json.load(f)
                if config.get("autostart") is True:
                    name = cli_file.stem.replace("_cli", "")
                    autostart.append(name)
        except Exception:
            continue
    
    return autostart

def _generate_service_file(instance_name: str) -> str:
    """Generate systemd service file content."""
    return f"""[Unit]
Description=Linux Voice Assistant - {instance_name}
After=network.target

[Service]
Type=simple
WorkingDirectory={_REPO_DIR}
ExecStart={_REPO_DIR}/script/run --name {instance_name}
Restart=always
RestartSec=5

[Install]
WantedBy=default.target
"""

def setup_service(instance_name: str, enable: bool = True, start: bool = False, create_symlink: bool = False, reload_daemon: bool = True) -> bool:
    """Setup systemd service for instance."""
    cli_file = _PREFS_USER_DIR / f"{instance_name}_cli.json"
    if not cli_file.exists():
        print(f"Error: Instance '{instance_name}' not found (no {cli_file.name})")
        return False
    
    # Ensure service directory exists
    _SERVICE_DIR.mkdir(parents=True, exist_ok=True)
    
    # Generate service file
    service_path = _get_service_path(instance_name)
    service_content = _generate_service_file(instance_name)
    
    try:
        with open(service_path, "w", encoding="utf-8") as f:
            f.write(service_content)
        print(f"Created: {service_path}")
        
        # Create symlink in user preferences folder
        if create_symlink:
            symlink_path = _PREFS_USER_DIR / _get_service_name(instance_name)
            if symlink_path.exists() or symlink_path.is_symlink():
                symlink_path.unlink()
            symlink_path.symlink_to(service_path)
            print(f"Symlinked: {symlink_path} -> {service_path}")
        
        # Reload systemd
        if reload_daemon:
            subprocess.run(["systemctl", "--user", "daemon-reload"], check=True)
        
        if enable:
            subprocess.run(["systemctl", "--user", "enable", _get_service_name(instance_name)], check=True)
            print(f"Enabled: {_get_service_name(instance_name)}")
        
        if start:
            subprocess.run(["systemctl", "--user", "start", _get_service_name(instance_name)], check=True)
            print(f"Started: {_get_service_name(instance_name)}")
        
        return True
    except Exception as e:
        print(f"Error setting up service: {e}")
        return False

def setup_all() -> None:
    """Setup services for all instances with autostart: true."""
    autostart = _get_autostart_instances()
    if not autostart:
        print("No instances with autostart: true found")
        return
    
    print(f"Found {len(autostart)} instance(s) with autostart enabled:")
    for name in autostart:
        print(f"  - {name}")
    
    print()
    success = 0
    for name in autostart:
        service_path = _get_service_path(name)
        if service_path.exists():
            print(f"[{name}] Service exists, updating and restarting...")
        else:
            print(f"[{name}] Setting up service...")
        
        # Skip daemon reload for each service, do it once at the end
        if setup_service(name, enable=True, start=False, create_symlink=True, reload_daemon=False):
            success += 1
    
    # Single daemon reload after all services are created
    print("Reloading systemd...")
    subprocess.run(["systemctl", "--user", "daemon-reload"], check=True)
    
    # Now start all services with delay between launches
    print("Starting services...")
    for i, name in enumerate(autostart):
        try:
            subprocess.run(["systemctl", "--user", "start", _get_service_name(name)], check=True)
            print(f"Started: {_get_service_name(name)}")
            # Add delay between launches (except after the last one)
            if i < len(autostart) - 1:
                time.sleep(2)
        except Exception as e:
            print(f"Error starting {name}: {e}")
    
    print(f"\nSetup complete: {success}/{len(autostart)} services ready and started")

def remove_service(instance_name: str) -> bool:
    """Remove systemd service for instance."""
    service_name = _get_service_name(instance_name)
    service_path = _get_service_path(instance_name)
    
    if not service_path.exists():
        print(f"Service not found: {service_path}")
        return False
    
    try:
        # Stop and disable service
        subprocess.run(["systemctl", "--user", "stop", service_name], check=False)
        subprocess.run(["systemctl", "--user", "disable", service_name], check=False)
        
        # Remove service file
        service_path.unlink()
        print(f"Removed: {service_path}")
        
        # Reload systemd
        subprocess.run(["systemctl", "--user", "daemon-reload"], check=True)
        
        return True
    except Exception as e:
        print(f"Error removing service: {e}")
        return False

def start_service(instance_name: str) -> bool:
    """Start service."""
    try:
        subprocess.run(["systemctl", "--user", "start", _get_service_name(instance_name)], check=True)
        print(f"Started: {_get_service_name(instance_name)}")
        return True
    except Exception as e:
        print(f"Error starting service: {e}")
        return False

def stop_service(instance_name: str) -> bool:
    """Stop service."""
    try:
        subprocess.run(["systemctl", "--user", "stop", _get_service_name(instance_name)], check=True)
        print(f"Stopped: {_get_service_name(instance_name)}")
        return True
    except Exception as e:
        print(f"Error stopping service: {e}")
        return False

def restart_service(instance_name: str) -> bool:
    """Restart service."""
    try:
        subprocess.run(["systemctl", "--user", "restart", _get_service_name(instance_name)], check=True)
        print(f"Restarted: {_get_service_name(instance_name)}")
        return True
    except Exception as e:
        print(f"Error restarting service: {e}")
        return False

def status_service(instance_name: str = None) -> None:
    """Show service status."""
    if instance_name:
        subprocess.run(["systemctl", "--user", "status", _get_service_name(instance_name)])
    else:
        # Show all lvas services
        subprocess.run(["systemctl", "--user", "list-units", "lvas_*"])

def logs_service(instance_name: str, follow: bool = False) -> None:
    """Show service logs."""
    cmd = ["journalctl", "--user", "-u", _get_service_name(instance_name)]
    if follow:
        cmd.append("-f")
    subprocess.run(cmd)

def list_services() -> None:
    """List all installed services."""
    print("Installed LVAS services:")
    print("=" * 50)
    
    # Get all instances and check which have services
    instances = _get_all_instances()
    if not instances:
        print("No instances found")
        return
    
    for name in sorted(instances):
        service_path = _get_service_path(name)
        if not service_path.exists():
            continue
        
        try:
            result = subprocess.run(
                ["systemctl", "--user", "is-active", _get_service_name(name)],
                capture_output=True,
                text=True
            )
            status = result.stdout.strip()
        except Exception:
            status = "unknown"
        
        print(f"  {name:20s} [{status}]")

def main():
    if len(sys.argv) < 2:
        print("Usage: script/service <command> [options]")
        print()
        print("Commands:")
        print("  setup-all              Setup services for instances with autostart: true")
        print("  setup <name>           Setup service for instance")
        print("  remove <name>          Remove service for instance")
        print("  start <name>           Start service")
        print("  stop <name>            Stop service")
        print("  restart <name>         Restart service")
        print("  status [name]          Show status (all services or specific)")
        print("  logs <name> [-f]       Show logs (use -f to follow)")
        print("  list                   List all installed services")
        sys.exit(1)
    
    command = sys.argv[1]
    
    if command == "setup-all":
        setup_all()
    elif command == "setup":
        if len(sys.argv) < 3:
            print("Error: Missing instance name")
            sys.exit(1)
        setup_service(sys.argv[2])
    elif command == "remove":
        if len(sys.argv) < 3:
            print("Error: Missing instance name")
            sys.exit(1)
        remove_service(sys.argv[2])
    elif command == "start":
        if len(sys.argv) < 3:
            print("Error: Missing instance name")
            sys.exit(1)
        start_service(sys.argv[2])
    elif command == "stop":
        if len(sys.argv) < 3:
            print("Error: Missing instance name")
            sys.exit(1)
        stop_service(sys.argv[2])
    elif command == "restart":
        if len(sys.argv) < 3:
            print("Error: Missing instance name")
            sys.exit(1)
        restart_service(sys.argv[2])
    elif command == "status":
        name = sys.argv[2] if len(sys.argv) > 2 else None
        status_service(name)
    elif command == "logs":
        if len(sys.argv) < 3:
            print("Error: Missing instance name")
            sys.exit(1)
        follow = "-f" in sys.argv
        logs_service(sys.argv[2], follow)
    elif command == "list":
        list_services()
    else:
        print(f"Unknown command: {command}")
        sys.exit(1)

if __name__ == "__main__":
    main()
